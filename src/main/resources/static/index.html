<!DOCTYPE html>
<html lang="en">
<head>
  <title>Hello MAIN</title>
<!--  <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<!--  <link href="/main.css" rel="stylesheet">-->
<!--  <script src="/webjars/jquery/jquery.min.js"></script>-->
</head>
<body>
<noscript>
  <h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being
  enabled. Please enable
  Javascript and reload this page!</h2></noscript>
<div id="main-content" class="container">
  <div class="row">
    <div class="col-md-6">
      <form class="form-inline">
        <div class="form-group">
          <button type="button" id="modalButton" class="btn btn-primary">Vincular con App-QR</button>
<!--          <button type="submit" class="btn btn-primary">Submit</button> -->
        </div>
      </form>
    </div>
  </div>

</div>


<div class="modal" tabindex="-1" id="myModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">


        <form id="form">
          <div class="mb-3">
            <label for="username" class="form-label">User name</label>
            <input type="text" class="form-control" id="username" aria-describedby="emailHelp">
            <div id="emailHelp" class="form-text">We'll never share your email with anyone else.</div>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password">
          </div>
          <button type="submit" class="btn btn-primary">Confirmar</button>
        </form>



      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script>

  var myModal = new bootstrap.Modal(document.getElementById('myModal'))
  var username = document.getElementById('username')
  var password = document.getElementById('password')
  var modalButton = document.getElementById('modalButton')
  const form = document.getElementById("form")
  const tenantToken = localStorage.getItem('Tenant-Auth-Token')
  const localToken = localStorage.getItem('Auth-Token')

  async function postData(url = '', data = {}, headers = {'Content-Type': 'application/json'}) {
    // Opciones por defecto estan marcadas con un *
    const response = await fetch(url, {
      method: 'POST', // *GET, POST, PUT, DELETE, etc.
      mode: 'cors', // no-cors, *cors, same-origin
      cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
      credentials: 'same-origin', // include, *same-origin, omit
      headers: headers,
      redirect: 'follow', // manual, *follow, error
      referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
      body: JSON.stringify(data) // body data type must match "Content-Type" header
    });
    return response.json(); // parses JSON response into native JavaScript objects
  }

  modalButton.addEventListener('click', (e) => {
    myModal.toggle()
  })


  //TODO: crea problemas con el token que se le pasa del lessor, creeria que es mejor un endpoint
  // en el servidor que haga ya todo el proceso de relacionar utilizando las credenciales y mandando la referencia.

  //AJAX PARA AUTENTICAR
  form.addEventListener("submit", function(evt) {
    evt.preventDefault()
    postData(
      'http://localhost:8080/jwt/user_lessor/authenticate',
      { username: username.value, password: password.value })
      .then(async data => {
        let lessortoken = data.token
        let reference = await postData(
          'http://localhost:9000/main/getUserIdReference',
          {},
          {'Content-Type': 'application/json', 'Authorization': localToken}
        ).catch(e => {
          console.log("error")
          console.log(e)
        })

        console.log("reference", reference)

        postData(
                'http://localhost:8080/relation',
                {lessorToken: lessortoken, reference: reference},
                {'Content-Type': 'application/json', 'Authorization': tenantToken}
        )
        .then(data => {
          console.log("esperando que relacione")
          console.log(data) // JSON data parsed by `data.json()` call
        })
        .catch(e => {
          console.log("error")
          console.log(e)
        })

      })
      .catch(e => {
        console.log("error")
        console.log(e)
      })
  })



</script>


</body>
</html>